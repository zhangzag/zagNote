function getNumber(e,t){$.ajax({url:e+"/order/getOrderCount",data:{memberId:t}}).done(function(e){if(e.success){var t=e.data[0],a=t.all,r=t.obligation,i=t.sendTheGoods,s=t.waitForReceiv,o=t.complete,n=t.cancel;$(".num_all span").text("("+a+")"),$(".num_wait span").text("("+r+")"),$(".num_wsend span").text("("+i+")"),$(".num_wget span").text("("+s+")"),$(".num_finish span").text("("+o+")"),$(".num_cancel span").text("("+n+")")}})}function optionsBtn(e,t,a){return"pay"==t?1===e?'<button class="btn_primary bp_orange">支付</button>':4===e?'<button class="btn_primary bp_green btn_order_comfirmget">确认收货</button>':"":"cancel"==t?1===e||2===e||3===e||9===e?'<a href="javascript:void(0);" class="btn_cancel_order">取消订单</a>':"":"express"==t?2!==e&&3!==e&&8!==e&&1!==e?'<a data-locod="'+(a.logistics?a.logistics.logisticsCode:"")+'" data-lono="'+(a.logisticsNumber?a.logisticsNumber:"")+'" data-sta="'+(a.orderStatus?a.orderStatus:"")+'" data-cod="'+(a.logistics?a.logistics.logisticsName:"")+'" data-lnum="'+(a.logisticsNumber?a.logisticsNumber:"")+'" data-tel="'+(a.logistics?a.logistics.phone:"")+'" href="javascript:void(0);" class="btn_check_express">查看物流</a>':"":void 0}function filterOrderStatu(e){return 5!==e&&6!==e&&7!==e&&8!==e}function filterStatus(e){return 1==e||9==e?"待付款":3==e||2==e?"待发货":4==e?"待收货":5==e||6==e||7==e?"已送达":8==e?"已取消":void 0}$(function(){var p=$.getGlobalVal().webRoot,s=$.getGlobalVal().memberId,t=$.getGlobalVal().webOrigin,o=!1,a=1,r=10,c="",u="",m=$.getQueryString("status")||"all";function i(){"1"==m?($(".num_wait").addClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"待付款",orderStatus:[1,9],page:a,limit:r})):"2"==m?($(".num_wsend").addClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"待发货",orderStatus:[2,3],page:a,limit:r})):"3"==m?($(".num_wget").addClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"待收货",orderStatus:[4],page:a,limit:r})):"4"==m?($(".num_finish").addClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"已完成",orderStatus:[5,6,7],page:a,limit:r})):"5"==m?($(".num_cancel").addClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"已取消",orderStatus:[8],page:a,limit:r})):"all"==m&&($(".num_all").addClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"all",page:a,limit:r}))}function g(e){var r=e.webRoot,i=e.memberId,s=e.webOrigin,t=e.orderType,a=e.orderStatus,o=e.page,n=e.limit;if(getNumber(r,i),"all"===t)var l=r+"/order/getOrderByMemberId",d={memberId:i,page:o,limit:n,recentDate:c,orderCodeOrProName:u},p="application/x-www-form-urlencoded; charset=UTF-8";else l=r+"/order/getOrderByMemberIdAndStatus",d=JSON.stringify({memberId:i,status:a,page:o,limit:n,recentDate:c,orderCodeOrProName:u}),p="application/json;charset=utf-8";$.ajax({url:l,data:d,contentType:p}).done(function(e){if(e.success){if(0===e.data.length)return $(".nothing").stop(!0,!0).show(0),$(".list_lists").stop(!0,!0).hide(0),void setTimeout(function(){$(".loading_animate").stop(!0,!0).slideUp("300")},300);$(".nothing").stop(!0,!0).hide(0),$(".list_lists").stop(!0,!0).show(0),$(".list_lists").html("");for(var t=0;t<e.data.length;t++){$(".list_lists").append('<div class="item"><div class="i_head"><span></span><span></span><span class="fr"></span></div><table class="akdefult_table" cellspacing="0" cellpadding="0" border="0"><col width="574" align="center" /><col width="186" align="center" /><col width="190" align="center" /><tbody><tr><td></td><td class="tc"></td><td class="tc"></td></tr></tbody></table></div>'),$(".i_head").eq(t).find("span").eq(0).text("订单号："+e.data[t].orderCode),$(".i_head").eq(t).find("span").eq(1).text("下单时间："+e.data[t].orderDate),$(".i_head").eq(t).find("span").eq(2).html('订单状态：<em class="'+(filterOrderStatu(e.data[t].orderStatus)?"c_orange":"")+'">'+$.orderStatuFilter(e.data[t].orderStatus)+"</em>");for(var a=0;a<e.data[t].orderDetails.length;a++)$(".list_lists .item").eq(t).find(".akdefult_table tbody td").eq(0).append('<div><div class="fl i_info"><div><a href="/products/'+e.data[t].orderDetails[a].productID+'.html"><img src="'+e.data[t].orderDetails[a].productUrl+'" alt=""></a></div><p>'+$.iconProImg(e.data[t].orderDetails[a].prescriptionType)+e.data[t].orderDetails[a].productName+"</p><span>规格："+e.data[t].orderDetails[a].productProperty+'</span></div><div class="fl prices"><span>'+$.priceFilter(e.data[t].orderDetails[a].marketPrice)+"</span><strong>"+$.priceFilter(e.data[t].orderDetails[a].price)+'</strong></div><div class="fr">'+e.data[t].orderDetails[a].qty+"</div></div>");$(".list_lists .item").eq(t).find(".akdefult_table tbody td").eq(1).append('<div class="prices"><p class="c_orange">'+$.priceFilter(e.data[t].factAmt)+"</p><span>"+$.payType(e.data[t].payType)+"</span></div>"),$(".list_lists .item").eq(t).find(".akdefult_table tbody td").eq(2).append('<div class="options" data-ori="'+e.data[t].orderID+'"><div>'+optionsBtn(e.data[t].orderStatus,"pay")+'</div><div><a href="./order_detail.html?ori='+e.data[t].orderID+'">订单详情</a></div><div>'+optionsBtn(e.data[t].orderStatus,"cancel")+"</div><div>"+optionsBtn(e.data[t].orderStatus,"express",e.data[t])+"</div></div>")}1==o&&layui.use("laypage",function(){layui.laypage.render({elem:"pagings",count:e.count,layout:["page","prev","next"],groups:9,limit:n,jump:function(e,t){$("body, html").scrollTop(0),t||(console.log("now orderTypeStatus: ",m),"1"==m?g({webRoot:r,memberId:i,webOrigin:s,orderType:"待付款",orderStatus:[1,9],page:e.curr,limit:n}):"2"==m?g({webRoot:r,memberId:i,webOrigin:s,orderType:"待发货",orderStatus:[2,3],page:e.curr,limit:n}):"3"==m?g({webRoot:r,memberId:i,webOrigin:s,orderType:"待收货",orderStatus:[4],page:e.curr,limit:n}):"4"==m?g({webRoot:r,memberId:i,webOrigin:s,orderType:"已完成",orderStatus:[5,6,7],page:e.curr,limit:n}):"5"==m?g({webRoot:r,memberId:i,webOrigin:s,orderType:"已取消",orderStatus:[8],page:e.curr,limit:n}):"all"==m&&g({webRoot:r,memberId:i,webOrigin:s,orderType:"all",page:e.curr,limit:n}))}})})}else console.log(e.msg);setTimeout(function(){$(".loading_animate").stop(!0,!0).slideUp("300")},300)})}$(".list_lists").on("click",".btn_cancel_order",function(){var r=$(this).parents(".options").attr("data-ori"),i=$(this);layui.use("layer",function(){var a=layui.layer;o||(o=!0,a.confirm("确定要取消订单？",{btn:["确定","取消"],btnAlign:"c"},function(e,t){$.ajax({url:p+"/order/updateOrderStatusByCancel",data:{orderId:r}}).done(function(e){a.closeAll(),e.success&&($(".tabs li.cur").hasClass("num_all")?(i.parents(".item").find(".i_head span.fr em").text("已取消").removeClass("c_orange"),i.parents(".item").find(".options .btn_primary").parent("div").remove(),i.parent("div").remove()):i.parents(".item").remove(),getNumber(p,s)),a.msg(e.msg)}).fail(function(){console.log("error")}).always(function(){o=!1})},function(e){console.log("取消"),o=!1}))})}),$(".list_lists").on("click",".btn_order_comfirmget",function(){var r=$(this).parents(".options").attr("data-ori"),i=$(this);o||(o=!0,layui.use("layer",function(){var a=layui.layer;a.confirm("确定要取消订单？",{btn:["确定","取消"],btnAlign:"c"},function(e,t){$.ajax({url:p+"/order/updateOrderStatusByConfirmReceipt",data:{orderId:r}}).done(function(e){e.success&&($(".tabs li.cur").hasClass("num_all")?(i.parents(".item").find(".i_head span.fr em").text("已完成").removeClass("c_orange"),i.parents(".item").find(".options .btn_order_comfirmget").parent("div").remove(),i.parent("div").remove()):i.parents(".item").remove(),getNumber(p,s)),a.alert(e.msg,{btnAlign:"c"})}).fail(function(){console.log("error")}).always(function(){o=!1})},function(e){console.log("取消"),o=!1})}))}),$(".list_lists").on("click",".btn_check_express",function(e){e.preventDefault();var a=e.pageX-86,r=e.pageY-50,i=$(".exp_layer").width()+30,t=$(this).attr("data-lono"),s=$(this).attr("data-locod"),o=filterStatus($(this).attr("data-sta")),n=$(this).attr("data-cod"),l=$(this).attr("data-lnum"),d=$(this).attr("data-tel");$.ajax({url:p+"/delivery/getLogistics",data:{logisticsNo:t,logisticsCode:s}}).done(function(e){if(e.success){$(".exp_line_status").text(o),$(".exp_line_company").text(n),$(".exp_line_num").text(l),$(".exp_line_tel").text(d),0===e.data.length&&$(".exp_layer .exp_detail .exp_detail_right").append('<p class="new_detail"><span>暂无物流信息</span></p>');for(var t=e.data.length-1;0<t;t--)$(".exp_layer .exp_detail .exp_detail_right").append('<p class="'+(t==e.data.length-1?"new_detail":"")+'"><span>【'+e.data[t].address+"】"+e.data[t].remark+"</span><span>"+e.data[t].time+"</span></p>")}else layui.use("layer",function(){layui.layer.msg("物流信息查询失败，"+e.msg)});$(".exp_layer").css({left:a-i,top:r}).stop(!0,!0).fadeIn(300)})}),$(".exp_head>i").click(function(e){e.preventDefault(),$(".exp_layer").stop(!0,!0).fadeOut(300),$(".exp_layer_in .exp_detail_right>p").remove()}),$("body").click(function(e){e.stopPropagation(),$(".exp_layer").stop(!0,!0).fadeOut(300),$(".exp_layer_in .exp_detail_right>p").remove()}),$(".exp_layer").click(function(e){e.stopPropagation()}),$(".num_all a").click(function(e){$(this).parents("li").hasClass("cur")||(u=c="",$('.top_search .fr>div>input[name="orderCodeOrProName"]').val(""),$(".loading_animate").stop(!0,!0).slideDown("300"),$(this).parents("li").addClass("cur"),$(this).parents("li").siblings().removeClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:m="all",page:a,limit:r}))}),$(".num_wait a").click(function(e){$(this).parents("li").hasClass("cur")||(u=c="",$('.top_search .fr>div>input[name="orderCodeOrProName"]').val(""),$(".loading_animate").stop(!0,!0).slideDown("300"),$(this).parents("li").addClass("cur"),$(this).parents("li").siblings().removeClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"待付款",orderStatus:[m=1,9],page:a,limit:r}))}),$(".num_wsend a").click(function(e){$(this).parents("li").hasClass("cur")||(u=c="",$('.top_search .fr>div>input[name="orderCodeOrProName"]').val(""),$(".loading_animate").stop(!0,!0).slideDown("300"),$(this).parents("li").addClass("cur"),$(this).parents("li").siblings().removeClass("cur"),g({webRoot:p,memberId:s,webOrigin:t,orderType:"待发货",orderStatus:[m=2,3],page:a,limit:r}))}),$(".num_wget a").click(function(e){$(this).parents("li").hasClass("cur")||(u=c="",$('.top_search .fr>div>input[name="orderCodeOrProName"]').val(""),$(".loading_animate").stop(!0,!0).slideDown("300"),$(this).parents("li").addClass("cur"),$(this).parents("li").siblings().removeClass("cur"),m=3,g({webRoot:p,memberId:s,webOrigin:t,orderType:"待收货",orderStatus:[4],page:a,limit:r}))}),$(".num_finish a").click(function(e){$(this).parents("li").hasClass("cur")||(u=c="",$('.top_search .fr>div>input[name="orderCodeOrProName"]').val(""),$(".loading_animate").stop(!0,!0).slideDown("300"),$(this).parents("li").addClass("cur"),$(this).parents("li").siblings().removeClass("cur"),m=4,g({webRoot:p,memberId:s,webOrigin:t,orderType:"已完成",orderStatus:[5,6,7],page:a,limit:r}))}),$(".num_cancel a").click(function(e){$(this).parents("li").hasClass("cur")||(u=c="",$('.top_search .fr>div>input[name="orderCodeOrProName"]').val(""),$(".loading_animate").stop(!0,!0).slideDown("300"),$(this).parents("li").addClass("cur"),$(this).parents("li").siblings().removeClass("cur"),m=5,g({webRoot:p,memberId:s,webOrigin:t,orderType:"已取消",orderStatus:[8],page:a,limit:r}))}),i(),$(".top_search>form").submit(function(e){c=$(this).find('select[name="recentDate"]').val(),u=$(this).find('input[name="orderCodeOrProName"]').val(),a=1,$(".loading_animate").stop(!0,!0).slideDown("300"),i()})});