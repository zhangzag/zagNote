$(function(){$.getGlobalVal().webRoot;function a(){var e=$(".picBtn>img").attr("src").indexOf("/sendCode"),s=$(".picBtn>img").attr("src").substring(0,e);$(".picBtn img").attr("src",s+"/sendCode?n="+Math.random())}$(".picBtn").click(function(){a()}),a();var r=function(){return $("#userPsw").val()!=$("#repeatPsw").val()?(p("#repeatPswTip","两次输入密码不一致，请再次输入密码!"),!1):($("#repeatPswTip").html("").css({display:"none"}),!0)},p=function(e,s){var t=$(e);t.html(s),t.show()},c=null;var d=0,f=6;!function e(){$(".steps").step({stepNames:["安全验证","短信验证码","设置新密码","设置完成"],initStep:1})}();c=null;var h=null;$("#nextStep").click(function(){var e,s,t,n=$.trim($("#userPhone").val()),i=$.trim($("#picCode").val()),o=$.trim($("#phoneCode").val()),l=$.trim($("#userPsw").val());$.trim($("#repeatPsw").val());if(0==d){if(!(""==(t=$.trim($("#userPhone").val()))?(p("#phoneErr","请输入正确的手机号!"),0):t.length<11?(p("#phoneErr","请输入正确的手机号!"),0):/^1[3|4|5|6|7|8|9][0-9]{9}$/.test(t)?($("#phoneErr").html("").css({display:"none"}),1):(p("#phoneErr","请输入正确的手机号!"),0)))return!1;$.ajax({url:"/verifyCode",type:"POST",dataType:"json",data:{telephone:n,code:i},xhrFields:{withCredentials:!0},crossDomain:!0}).done(function(e){if(1!=e.msg)return p("#picErr",e.msg),a(),!1;$(".steps").step("next"),d++,$(".forget").eq(d).css({display:"block"}).siblings().css({display:"none"}),function s(e){$("#getPhoneCode").html(e+"s后重新获取").attr({disabled:"disabled"}),clearInterval(c),c=setInterval(function(){e--,$("#getPhoneCode").html(e+"s后重新获取"),e<=0&&(clearInterval(c),$("#getPhoneCode").html("重新获取验证码").attr({disabled:!1}),$(".steps").step("previous"),d--,$(".forget").eq(d).css({display:"block"}).siblings().css({display:"none"}))},1e3)}(120)}).fail(function(e){console.log(e),a()})}else if(1==d)$.ajax({url:"/verifyMessage",type:"POST",dataType:"json",data:{telephone:n,randomCode:o}}).done(function(e){h=e.num,$(".steps").step("next"),d++,$(".forget").eq(d).css({display:"block"}).siblings().css({display:"none"})}).fail(function(e){p("#picErr","短信验证码错误，请重新获取!"),$(".steps").step("previous"),d--,$(".forget").eq(d).css({display:"block"}).siblings().css({display:"none"})});else if(2==d){if(!(""==(s=$("#userPsw").val())?(p("#pswTip","请输入密码!"),0):s.length<6||16<s.length?(p("#pswTip","密码为6-16位数字、字母或者符号!"),0):($("#pswTip").html("").css({display:"none"}),1)))return!1;if(!(""==(e=$("#repeatPsw").val())?(p("#repeatPswTip","请再次输入密码!"),0):e.length<6||16<e.length?(p("#repeatPswTip","确认密码为6-16位数字、字母或者符号!"),0):r()&&($("#repeatPswTip").html("").css({display:"none"}),1)))return!1;if(!r())return!1;$.ajax({url:"/changePassword",type:"POST",dataType:"json",data:{telephone:n,randomCodeTwo:h,password:l}}).done(function(e){if(101==e.code)return p("#pswTip","您设置的密码与原密码相同，请重新设置!"),!1;$(".steps").step("next"),d++,$(".forget").eq(d).css({display:"block"}).siblings().css({display:"none"}),$(".fotget-ok .se span").eq(0).html(f),$("#nextStep").eq(0).html("返回首页"),setInterval(function(){f--,$(".fotget-ok .se span").eq(0).html(f),f<0&&(window.location.href="index.html")},1e3)}).fail(function(e){console.log(e)})}else window.location.href="index.html"})});