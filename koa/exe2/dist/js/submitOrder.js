function getQueryString(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),a=window.location.search.substr(1).match(t);return null!=a?decodeURI(a[2]):null}function imgSrcInit(e){return e}$(function(){var e=window.location.host;e=-1==e.indexOf(".ak1ak1.com")?"":".ak1ak1.com";var r=$.cookie("order")?JSON.parse($.cookie("order")):null;r&&"null"!=r||window.history.go(-1),$.getGlobalVal().memberId||window.history.go(-1);var s=r.productId,d=null;function c(){$.ajax({url:$.getGlobalVal().webRoot+"/delivery/getDeliveryAddress?memberId="+$.getGlobalVal().memberId,type:"GET",dataType:"json",data:{},async:!1,success:function(e){$(".address-list").html("");for(var t=0;t<e.length;t++){var a=""==e[t].mobile?e[t].telephone:e[t].mobile;if(1==e[t].isDefault)var s='<li addressID="'+e[t].addressID+'"><button class="choice" addressID="'+e[t].addressID+'">'+e[t].address.substring(0,4)+'</button><div class="address-name"><span>('+e[t].contactMan+' 收)</span><span class="addressDetail">'+e[t].address+"</span><span>"+a+'</span><span class="def-address">默认地址</span></div><div class="operation"><span class="modifyAlert">修改</span><span class="delAddress">删除</span></div></li>';else s='<li addressID="'+e[t].addressID+'"><button class="choice" addressID="'+e[t].addressID+'">'+e[t].address.substring(0,4)+'</button><div class="address-name"><span>('+e[t].contactMan+' 收)</span><span class="addressDetail">'+e[t].address+"</span><span>"+a+'</span></div><div class="operation"><span class="set-up-def">设为默认地址</span><span class="modifyAlert">修改</span><span class="delAddress">删除</span></div></li>';$(".address-list").append(s)}$(".address-list").find(".choice").eq(0).addClass("choice-active");var i=$(".distribution .type .logisticsActive").attr("logisticsId"),o=$(".distribution .type .logisticsActive").attr("logIndex");i&&l(e[0].addressID,null,o)},error:function(e){console.log(e)}})}3==r.orderType?($.ajax({url:$.getGlobalVal().webRoot+"/getComboByProductId",type:"POST",dataType:"json",data:{productID:s},async:!1,success:function(e){d=e.data[r.index]},error:function(e){console.log(e)}}),$.ajax({url:$.getGlobalVal().webRoot+"/getComboDetailByPackageId",type:"POST",dataType:"json",data:{packageID:r.packageID},async:!1,success:function(e){for(var t,a=e.data,s="",i=0;i<a.length;i++){var o=a[i].photodURL?a[i].photodURL:"/static/images/ak_200x200.jpg",r=a[i].price*a[i].qty;r=r.toFixed(2),s+='<li><div class="p-info"><div class="p-img"><img src="'+o+'" ></div><div class="p-text"><p class="p-name"><i class="'+$.imgType(a[i].prescriptionType)+'"></i> '+a[i].productName+'</p><p class="p-gui">'+a[i].spec+'</p></div></div><div  class="p-pri"><p class="new-pri" style="padding-top:20px;">'+a[i].price+'</p></div><div class="p-num">'+a[i].qty+'</div><div class="p-subtotal">'+r+"</div></li>"}t=d.oldCost,$(".order-list").html(s),$(".submit-w .proMoney").html(t)}})):2==r.orderType?($.ajax({url:$.getGlobalVal().webRoot+"/getSingleComboByProductId",type:"POST",dataType:"json",data:{productID:s},async:!1,success:function(e){d=e.data[0]},error:function(e){console.log(e)}}),$.ajax({url:$.getGlobalVal().webRoot+"/getComboDetailByPackageId",type:"POST",dataType:"json",data:{packageID:r.packageID},async:!1,success:function(e){var t,a=e.data,s="";singleDetail=a[r.index];var i=singleDetail.photodURL?singleDetail.photodURL:"/static/images/ak_200x200.jpg",o=singleDetail.ourPrice*r.qty;o=o.toFixed(2),s+='<li><div class="p-info"><div class="p-img"><img src="'+i+'" ></div><div class="p-text"><p class="p-name"><i class="'+$.imgType(singleDetail.prescriptionType)+'"></i> '+singleDetail.productName+'</p><p class="p-gui">'+singleDetail.spec+'</p></div></div><div  class="p-pri"><p class="new-pri" style="padding-top:20px;">'+singleDetail.ourPrice+'</p></div><div class="p-num">'+r.qty+'</div><div class="p-subtotal">'+o+"</div></li>",t=o,$(".order-list").html(s),$(".submit-w .proMoney").html(t)}})):$.ajax({url:$.getGlobalVal().webRoot+"/product/getProductByProductId",type:"POST",dataType:"json",data:{productId:s},async:!1,success:function(e){d=e.data;var t=e.data.ourPrice*r.qty;t=t.toFixed(2),$(".order-list").html("");var a='<li><div class="p-info"><div class="p-img"><img src="'+(e.data.photodURL?e.data.photodURL:"/static/images/ak_300x300.jpg")+'" ></div><div class="p-text"><p class="p-name"><i class="'+$.imgType(e.data.prescriptionType)+'"></i> '+e.data.productName+'</p><p class="p-gui">'+e.data.spec+'</p></div></div><div  class="p-pri"><p class="old-pri">'+e.data.price+'</p><p class="new-pri">'+e.data.ourPrice+'</p></div><div class="p-num">'+r.qty+'</div><div class="p-subtotal">'+t+"</div></li>";$(".order-list").append(a),$(".submit-w .proMoney").html(t)},error:function(e){}}),c(),$(".address-foot .take-up").click(function(){"显示全部地址"==$(this).find("span").html()?($(this).find("span").html("收起部分地址").next().removeClass("layui-icon-down").addClass("layui-icon-up"),$(".address-list").removeClass("address-active")):($(this).find("span").html("显示全部地址").next().removeClass("layui-icon-up").addClass("layui-icon-down"),$(".address-list").addClass("address-active"))}),$(".address-w").on("click",".set-up-def",function(){var t=this;$.ajax({url:$.getGlobalVal().webRoot+"/delivery/isDefualt",type:"POST",dataType:"json",data:{memberID:$.getGlobalVal().memberId,addressID:$(t).parent().parent().attr("addressID"),isDefault:1},success:function(e){if(!e.success)return!1;$(".address-w .def-address").remove(),$(t).parent().prev().append('<span class="def-address">默认地址</span>'),$(t).parent().parent().siblings().find(".set-up-def").remove(),$(t).parent().parent().siblings().find(".operation").prepend('<span class="set-up-def">设为默认地址</span>'),$(t).remove()},error:function(e){}})});var p=null;function t(e,a){$.ajax({url:$.getGlobalVal().webRoot+"/selectArea",type:"POST",dataType:"json",data:{parentId:e},async:!1}).done(function(e){if("省"==a){$("#province").html('<option value="请选择">请选择</option>');for(var t=0;t<e.length;t++)$("#province").append('<option value="'+e[t].id+'">'+e[t].name+"</option>")}else if("市"==a){$("#city").html('<option value="请选择">请选择</option>');for(t=0;t<e.length;t++)$("#city").append('<option value="'+e[t].id+'">'+e[t].name+"</option>")}else if("区"==a){$("#county").html('<option value="请选择">请选择</option>');for(t=0;t<e.length;t++)$("#county").append('<option value="'+e[t].id+'">'+e[t].name+"</option>")}})}function a(t){var e=$.getGlobalVal().memberId,a=$("#province").val(),s=$("#city").val(),i=$("#county").val(),o=$.trim($("#addressAlert .address-detail").val()),r=$.trim($("#addressAlert .phone").val()),d=$.trim($("#addressAlert .tel-area").val())+"-"+$.trim($("#addressAlert .tel").val());contactMan=$.trim($("#addressAlert .address-name").val()),t=t||null;var l=$("#addressAlert").attr("isDefault")?$("#addressAlert").attr("isDefault"):0;if("请选择"==a||"请选择"==s||"请选择"==i)return y("请选择省市区",2),!1;if(""==o)return y("请填写详细地址",2),!1;if(""==contactMan)return y("请填写收货人",2),!1;if(""==r&&"-"==d)return y("请填写联系电话",2),!1;if(!/^1[3|4|5|6|7|8|9][0-9]{9}$/.test(r)&&!/^(0[0-9]{2,3}\-)([2-9][0-9]{6,7})+(\-[0-9]{1,4})?$/.test(d))return y("电话号码格式不正确！",2),!1;d="-"==d?null:d;var n=null==(r=""==r?null:r)?d:r;$.ajax({url:$.getGlobalVal().webRoot+"/delivery/addDeliveryAddress",type:"POST",dataType:"json",data:{memberID:e,isDefault:l,countryID:1,districtID:a,city:s,county:i,address:o,mobile:r,telephone:d,phone:n,contactMan:contactMan,addressID:t},success:function(e){e.success&&(layer.close(p),y(t?"修改地址成功":"添加地址成功",1)),c()},error:function(e){console.log(e)}})}$(".new-add").click(function(){$("#addressAlert").attr({alertType:"0"}),$("#province").val("请选择"),$("#city").val("请选择"),$("#county").val("请选择"),$("#addressAlert .address-detail").val(""),$("#addressAlert .phone").val(""),$("#addressAlert .tel-area").val(""),$("#addressAlert .tel").val(""),$("#addressAlert .address-name").val(""),layui.use("layer",function(){p=layer.open({type:1,area:"590px",title:["新增收货地址","background-color: #E8E8E8;"],content:$("#addressAlert"),cancel:function(){}})}),t(null,"省")}),$(".address-list").on("click",".modifyAlert",function(){$.ajax({url:$.getGlobalVal().webRoot+"/delivery/getDeliveryAddressByMemberID?memberID="+$.getGlobalVal().memberId+"&addressID="+$(this).parent().parent().attr("addressID"),type:"POST",data:"json",data:{},success:function(e){$("#addressAlert").attr({alertType:"1",addressID:e.data.addressID,isDefault:e.data.isDefault}),t(null,"省"),t(e.data.districtID,"市"),t(e.data.city,"区"),$("#province").val(e.data.districtID),$("#city").val(e.data.city),$("#county").val(e.data.county),$("#addressAlert .address-detail").val(e.data.address),$("#addressAlert .phone").val(e.data.mobile),""!=e.data.telephone&&null!=e.data.telephone&&($("#addressAlert .tel-area").val(e.data.telephone.split("-")[0]),$("#addressAlert .tel").val(e.data.telephone.split("-")[1])),$("#addressAlert .address-name").val(e.data.contactMan),layui.use("layer",function(){p=layer.open({type:1,area:"590px",title:["修改收货地址","background-color: #E8E8E8;"],content:$("#addressAlert"),cancel:function(){}})})},error:function(e){}})}),$("#province").change(function(){if("请选择"==$(this).val())return $("#city").html('<option value="请选择">请选择</option>'),$("#county").html('<option value="请选择">请选择</option>'),!1;$("#city").html('<option value="请选择">请选择</option>'),$("#county").html('<option value="请选择">请选择</option>'),t(Number($(this).val()),"市")}),$("#city").change(function(){if("请选择"==$(this).val())return $("#county").html('<option value="请选择">请选择</option>'),!1;$("#county").html('<option value="请选择">请选择</option>'),t(Number($(this).val()),"区")}),$(".modify-btn").click(function(){"0"==$("#addressAlert").attr("alertType")?a():"1"==$("#addressAlert").attr("alertType")&&a($("#addressAlert").attr("addressID"))}),$(".address-list").on("click",".delAddress",function(){var t=this;layui.use("layer",function(){layer.confirm("您确定删除该地址吗?",{icon:3,title:"删除提示"},function(e){layer.close(e),$.ajax({url:$.getGlobalVal().webRoot+"/delivery/delDeliveryAddress",type:"POST",dataType:"json",data:{memberID:$.getGlobalVal().memberId,addressID:$(t).parent().parent().attr("addressID")},success:function(e){e.success&&y("删除地址成功",1),c()},err:function(e){console.log(e)}})},function(e){layer.close(e)})})}),$(".pay .type a").click(function(){$(this).addClass("active").siblings().removeClass("active")});var i=$(".submit-w .proMoney").html(),o=$(".address-list .choice-active").attr("addressId");function l(e,t,s){e=e;var a=$(".submit-w .proMoney").html();if(!e)return!1;$.ajax({url:$.getGlobalVal().webRoot+"/order/getLogisticsCharge",type:"POST",dataType:"json",data:{addressId:e,orderAMT:a,timestamp:$.getGlobalVal().curDate,sysNo:"pc"},async:!1,success:function(e){var t=e[s],a=t.expressfeeName?t.expressfeeName:"￥ "+t.byWeight.charge;$(".distribution .freight span").html(a).attr({freight:t.byWeight.charge}),$(".submit-w .logisticsMoney").html(t.byWeight.charge)},error:function(e){console.log(e)}})}$.ajax({url:$.getGlobalVal().webRoot+"/order/getLogisticsCharge",type:"POST",dataType:"json",data:{addressId:o,orderAMT:i,timestamp:$.getGlobalVal().curDate,sysNo:"pc"},async:!1,success:function(e){for(var t=0;t<e.length;t++){var a='<a charge="'+e[t].byWeight.charge+'" logisticsId="'+e[t].logisticsID+'" logIndex="'+t+'" href="javascript:void(0)">'+e[t].logisticsName+"</a>";$(".distribution .type").append(a)}$(".distribution .type a").eq(0).addClass("logisticsActive")},error:function(e){console.log(e)}});o=$(".choice-active").attr("addressID"),$(".distribution .type .logisticsActive").attr("logisticsId");function n(){var e=$(".submit-w .proMoney").html(),t=$(".submit-w .logisticsMoney").html(),a=$(".submit-w .discountMoney").html();3==r.orderType?(a=d.oldCost-d.afterBenefitCost,$(".submit-w .discountMoney").html(a.toFixed(2))):r.orderType;var s=Number(e)+Number(t)-Number(a);s=s.toFixed(2),$(".submit-w .orderMoney").html(s)}l(o,0,0),$(".distribution .type").on("click","a",function(){$(this).addClass("logisticsActive").siblings().removeClass("logisticsActive");var e=$(".choice-active").attr("addressID");$(this).attr("logisticsId");l(e,0,$(this).index()),n()}),$(".address-w").on("click",".choice",function(){$(".address-w .choice").removeClass("choice-active"),$(this).addClass("choice-active");var e=$(this).attr("addressID");$(".distribution .type .logisticsActive").attr("logisticsId");l(e,0,$(".distribution .type .logisticsActive").attr("logIndex")),n()}),function v(){var e=$(".submit-w .proMoney").html(),t=2==r.orderType?r.discountMoney:0,a={productId:s,totalPrice:e-t,qty:r.qty,sysNo:"pc"};2==r.orderType&&(a.packageID=r.packageID),$.ajax({url:$.getGlobalVal().webRoot+"/order/getDiscountsPrice",type:"POST",dataType:"json",data:a,async:!1,success:function(e){2==r.orderType?$(".submit-w .discountMoney").html((e.discountsPrice+t).toFixed(2)):$(".submit-w .discountMoney").html(e.discountsPrice.toFixed(2))},error:function(e){console.log(e)}})}(),n();var u=!0;$(".subOrder").click(function(){if(!$(".choice-active").attr("addressID"))return $.tips("请选择收货地址！",2),!1;if(1==r.orderType){var e={productId:s,memberId:$.getGlobalVal().memberId,detailCodeId:d.detailCodeID,qty:Number(r.qty),addressID:$(".choice-active").attr("addressID"),deliveryAddress:$(".choice-active").next().find(".addressDetail").html(),logisticsID:$(".logisticsActive").attr("logisticsId"),payType:4,orderRemark:$.trim($(".remark textarea").val()),sysNo:"pc"};u&&(u=!1,$.ajax({url:$.getGlobalVal().webRoot+"/order/addorder",type:"POST",dataType:"json",data:e,async:!1,success:function(e){!0===e.success?window.location.href="/submitSuccess.html":$.tips("提交订单失败！",2),u=!0},error:function(e){u=!0}}),setTimeout(function(){u=!0},1e3))}else if(3==r.orderType){e={packageID:r.packageID,memberId:$.getGlobalVal().memberId,qty:r.qty,addressID:$(".choice-active").attr("addressID"),deliveryAddress:$(".choice-active").next().find(".addressDetail").html(),logisticsID:$(".logisticsActive").attr("logisticsId"),payType:4,orderRemark:$.trim($(".remark textarea").val()),sysNo:"pc"};u&&(u=!1,$.ajax({url:$.getGlobalVal().webRoot+"/order/addComboOrder",type:"POST",dataType:"json",data:e,async:!1,success:function(e){!0===e.success?window.location.href="/submitSuccess.html":$.tips("提交订单失败！",2),u=!0},error:function(e){console.log(e),u=!0}}),setTimeout(function(){u=!0},1e3))}else if(2==r.orderType){e={packageID:r.packageID,productId:s,memberId:$.getGlobalVal().memberId,qty:r.qty,addressID:$(".choice-active").attr("addressID"),deliveryAddress:$(".choice-active").next().find(".addressDetail").html(),logisticsID:$(".logisticsActive").attr("logisticsId"),payType:4,orderRemark:$.trim($(".remark textarea").val()),sysNo:"pc"};u&&(u=!1,$.ajax({url:$.getGlobalVal().webRoot+"/order/addorder",type:"POST",dataType:"json",data:e,async:!1,success:function(e){!0===e.success?($.tips("提交订单成功！",1),window.location.href="/submitSuccess.html"):$.tips("提交订单失败！",2),u=!0},error:function(e){u=!0}}),setTimeout(function(){u=!0},1e3))}});var y=function(e,t){layui.use("layer",function(){layer.msg(e,{icon:t,time:1e3})})}});